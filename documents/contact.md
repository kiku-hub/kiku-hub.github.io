# お問い合わせフォーム実装仕様書

## 1. システム概要

**目的**: ウェブサイト訪問者からのお問い合わせを受け付け、適切に処理するシステム

**処理フロー**:

```
[ユーザー] → [フォーム入力] → [バリデーション] → [GAS処理] → [メール送信] → [管理者/ユーザー]
```

## 2. フロントエンド実装

### 2.1 コンポーネント構成

- **Contact.jsx**: お問い合わせセクション全体のコンテナー
- **ContactForm.jsx**: フォーム実装の本体
- **PrivacyPolicyModal.jsx**: プライバシーポリシー表示用モーダル

### 2.2 フォーム項目定義

| フィールド名         | 変数名   | 必須 | バリデーション                   | 備考             |
| -------------------- | -------- | ---- | -------------------------------- | ---------------- |
| お問い合わせ種別     | type     | ✅   | 選択必須                         | セレクトボックス |
| 会社名/組織名        | company  | ❌   | 最大 100 文字                    | テキスト入力     |
| お名前               | name     | ✅   | 必須・最大 50 文字               | テキスト入力     |
| フリガナ             | nameKana | ✅   | 必須・全角カタカナ・最大 50 文字 | テキスト入力     |
| 電話番号             | phone    | ✅   | 必須・数字・形式確認             | 例: 03-1234-5678 |
| メールアドレス       | email    | ✅   | 必須・メール形式・最大 256 文字  | メール形式確認   |
| お問い合わせ内容     | message  | ✅   | 必須・10〜1000 文字              | テキストエリア   |
| プライバシーポリシー | privacy  | ✅   | チェック必須                     | 全文確認必須     |

### 2.3 データ送信処理

```javascript
// POST処理の実装（ContactForm.jsx内）
const onSubmit = async (data) => {
  setLoading(true);

  try {
    const response = await fetch(import.meta.env.VITE_GAS_DEPLOYMENT_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      mode: "cors",
      redirect: "follow",
      body: JSON.stringify(data),
    });

    const result = await response.json();

    if (result.status === "success") {
      alert(contactContent.alerts.success);
      reset();
    } else {
      throw new Error(result.message || "メール送信に失敗しました");
    }
  } catch (error) {
    console.error(error);
    alert(contactContent.alerts.error);
  } finally {
    setLoading(false);
  }
};
```

## 3. バックエンド実装 (GAS)

### 3.1 GAS スクリプト概要

Google Apps Script を使用して、フォームデータの受信・処理・メール送信を実装

### 3.2 主要関数説明

| 関数名                           | 役割                                    | 呼び出し元      |
| -------------------------------- | --------------------------------------- | --------------- |
| `doPost(e)`                      | POST リクエスト処理のエントリーポイント | Web アプリ      |
| `doOptions()`                    | CORS プリフライトリクエスト対応         | Web アプリ      |
| `validateFormData(data)`         | フォームデータのバリデーション          | doPost          |
| `sendEmails(data)`               | メール送信処理                          | doPost          |
| `createAdminEmailBody(data)`     | 管理者宛メール本文作成                  | sendEmails      |
| `createAutoReplyEmailBody(data)` | 自動返信メール本文作成                  | sendEmails      |
| `getInquiryTypeName(typeCode)`   | 問い合わせ種別コード変換                | createEmailBody |

### 3.3 メール送信設定

#### 管理者通知メール

- **宛先**: info@orcx.co.jp (メーリングリスト)
- **件名**: ウェブサイトからのお問い合わせ
- **送信元**: info@orcx.co.jp
- **送信者名**: ORCX 株式会社 お問い合わせシステム
- **内容**: フォーム入力内容全項目

#### 自動返信メール

- **宛先**: 入力されたメールアドレス
- **件名**: 【ORCX 株式会社】お問い合わせありがとうございます
- **送信元**: info@orcx.co.jp
- **送信者名**: ORCX 株式会社
- **内容**: 受付確認・入力内容の一部・会社情報

## 4. Google ワークスペース設定

### 4.1 `info@orcx.co.jp`メーリングリスト設定

以下の設定が必要です：

1. **管理コンソール操作**

   - アクセス: admin.google.com
   - ナビゲーション: グループ → info@orcx.co.jp → 設定 → 権限
   - 設定項目: 「グループをメール送信元として使用する」を有効化

2. **実行ユーザー設定**
   - GAS を実行するユーザーがグループメンバーであることを確認
   - グループの「グループとして送信する」権限を付与

### 4.2 メール送信量制限

GAS のメール送信には以下の制限があります：

- 1 日あたりの送信制限: 100 通
- 1 回のスクリプト実行: 最大 20 通
- 受信者リスト: 最大 100 アドレス

## 5. 環境設定とデプロイ

### 5.1 環境変数設定

```
# .env (実際のファイル)
VITE_GAS_DEPLOYMENT_URL=https://script.google.com/macros/s/【実際のデプロイID】/exec

# .env.example (サンプル)
VITE_GAS_DEPLOYMENT_URL=https://script.google.com/macros/s/your-deployment-id-here/exec
```

### 5.2 GAS デプロイ手順

1. **新規プロジェクト作成**

   - Google Apps Script: https://script.google.com/ にアクセス
   - 「新しいプロジェクト」→ コードペースト

2. **Web アプリとしてデプロイ**

   - 「デプロイ」→「新しいデプロイ」→「種類の選択」→「ウェブアプリ」
   - 実行ユーザー: 自分
   - アクセス権限: 全員（匿名ユーザーを含む）
   - 「デプロイ」ボタンをクリック
   - 生成された URL をコピー

3. **環境変数更新**
   - コピーした URL を`.env`ファイルの`VITE_GAS_DEPLOYMENT_URL`に設定

## 6. 動作テスト

### 6.1 ローカル環境テスト

```bash
# 開発サーバー起動
npm run dev

# ブラウザでアクセス
open http://localhost:5173/contact
```

### 6.2 テスト項目

1. **バリデーション確認**

   - 各必須項目の入力チェック
   - フリガナの全角カタカナチェック
   - メールアドレス形式チェック
   - 電話番号形式チェック

2. **送信テスト**
   - フォーム送信
   - GAS での受信確認
   - メール送信確認（管理者宛・返信メール）

## 7. トラブルシューティング

### 7.1 よくある問題と解決方法

| 問題                 | 確認ポイント                            | 解決方法                                         |
| -------------------- | --------------------------------------- | ------------------------------------------------ |
| CORS エラー          | ブラウザコンソールのエラーメッセージ    | GAS のデプロイ設定で「全員がアクセス可能」に変更 |
| メール送信失敗       | GAS の実行ログ                          | 送信量制限の確認、権限設定の確認                 |
| フォーム送信エラー   | ネットワークタブのリクエスト/レスポンス | GAS URL の正確な設定、環境変数の確認             |
| バリデーションエラー | フォーム入力時のエラーメッセージ        | バリデーションルールの確認                       |

### 7.2 デバッグ方法

- **フロントエンド**: ブラウザのコンソールログで確認
- **バックエンド**: GAS の「実行」→「ログを表示」で確認
- **ネットワーク**: ブラウザの開発者ツール「Network」タブで通信確認

## 8. セキュリティ対策

- **CORS 設定**: 特定ドメインからのアクセスのみ許可
- **データ検証**: フロントとバックエンドの両方でバリデーション
- **送信元制限**: 許可されたドメインからのリクエストのみ処理
- **エラーログ**: 不正アクセスなどのログ記録と監視
- **環境変数管理**: `.env`ファイルでの秘匿情報管理と`.gitignore`での除外

## 9. 保守・運用

- **定期動作確認**: 月 1 回のテスト送信
- **GAS スクリプト更新**: 機能追加・バグ修正時
- **エラーログ監視**: 週 1 回のログ確認
- **デプロイ URL 管理**: 再デプロイ時の環境変数更新
